<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Let's train agile multiplication :)</title>
    <style>
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Firefox */
        input[type=number] {
            -moz-appearance: textfield;
        }

        #Solution {
            border: 1px solid black;
            margin-bottom: 15px;
            background-color: black;
            padding-bottom: 20px;
            min-width: 100%;
            position: fixed;
            left: 0px;
            z-index: 20;
        }

        button {
            background-color: dimgrey;
            border: none;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            cursor: pointer;
            width: 49%;
            color: #d7ba7d;
            margin-top: 5px;
            height: 4em;
            vertical-align: top;
        }

        header {
            color: #d7ba7d;
            margin-bottom: 50px;
        }

        header p {
            margin-top: 5px;
        }

        h1 {
            margin-bottom: 5px;
        }

        button:focus {
            outline: none !important;
        }

        #solution {
            border: none;
            text-align: center;
            width: 100%;
            color: #6e270b;
            background-color: darkgrey;
            height: 2em;
            border-radius: 25px;
            padding: 0px 00px;
            font-size: larger;
        }

        #solution:focus {
            outline: none !important;
        }

        .valid {
            color: green;
        }

        .invalid {
            color: red;
        }

        #wrapper {
            width: 350px;
            margin: auto;
            text-align: center;
            margin-top: 10%;
        }

        #task {
            font-weight: bold;
            font-size: xx-large;
        }

        #current-task {
            border-radius: 25px;
            line-height: 2em;
            display: inline-block;
            margin: 0.5em;
        }

        body {
            background-color: #252526;
            color: #d7ba7d;
            font-size: larger;
        }

        .config {
            width: 20%;
            display: inline-block;
            padding: 0;
            border: none;
            height: 2em;
            text-align: center;
            vertical-align: middle;
            background-color: darkgrey;
            color: #6e270b;
            border-radius: 25px;
        }

        .config-label {
            display: inline-block;
            width: 50%;
        }

        .config:focus {
            outline: none !important;
        }

        #config {
            margin: 10px auto;
            width: 350px;
            text-align: left;
        }

        #config p {
            margin: 5px 0px 2px 0px;
        }

        #control {
            width: 350px;
            margin: auto;
        }

        .hidden {
            display: none;
        }

        #nav {
            margin-bottom: 50px;
            background-color: black;
            padding: 10px 0px 40px 0px;
            min-width: 100%;
            position: fixed;
            left: 0px;
            z-index: 10;
        }

        #input {
            margin-bottom: 1em;
        }

        #input img {
            float: right;
            position: absolute;
            height: 1.5em;
            width: 1.2em;
            margin: 8px 0px 0px 15px;
        }

        #partial-solutions {
            font-family: monospace;
            text-align: center;
            white-space: pre;
            padding: 10px;
        }

        #temp-solutions {
            display: inline-block;
            font-size: x-large;
        }
    </style>
</head>

<body>
    <div id="wrapper">
        <header onclick="toggleNav()">
            <h1>Mula</h1>
            <p>Agile Multiplication Trainer</p>
        </header>
        <div id="Solution" style="display: none;" onclick="toggleSolution()">
            <h2>Solutions</h2>
            <h3 id="Solution-task"></h3>
            <p id="partial-solutions"></p>
        </div>
        <div id="nav" class="hidden">
            <h2 onclick="toggleNav()">(O)ptions</h2>
            <div id="control">
                <button id="newTask" title="Create a new task based on the config and reset the view."
                    onclick="newTask()">(N)ew</button>
                <button id="submit" title="Submit and validate the current result." onclick="saveTempSolution()">(<span
                        style="font-size: x-small;">‚èé</span>) Validate</button>
                <button id="toggleFullScreen" title="Switch to full screen mode and back."
                    onclick="toggleFullScreen()">(F)ullscreen</button>
                <button id="toggleSolution" title="Show the solution and steps as a hint."
                    onclick="toggleSolution()">(S)olution</button>
                <button id="voiceMode" title="Use voice recognition instead of keyboard input."
                    onclick="toggleVoiceMode()"></button>
                <button id="impress" title="Print legal information and credits." onclick="">(L)egal Notice<br /><span
                        style='font-size: x-small'>(Impressum)</span></button>
            </div>
            <div id="config">
                <p><span class="config-label"># of digits:</span><input class="config" type="number" id="f1"
                        name="factor1" placeholder="1" value="1" onclick="this.select();" oninput="newTask(false)" />
                    <input class="config" type="number" id="f2" name="factor2" placeholder="2" value="2"
                        onclick="this.select();" oninput="newTask(false)" /></p>
                <p><span class="config-label">auto task after:</span><input class="config" type="number"
                        id="autoTaskInput" name="autoTaskInput" placeholder="-" value="" onclick="this.select();"
                        oninput="saveAutoTaskInterval()" />
                    <span>sec.</span></p>
            </div>
        </div>
        <section id="task">
            <p id="current-task" onclick="newTask()"></p>
        </section>
        <section id="input" class="speech" onclick="startDictation()">
            <img id="mic-image" class="hidden" src="32px-Font_Awesome_5_solid_microphone-alt.svg.png" />
            <input type="number" id="solution" name="solution" placeholder="=" />
        </section>
        <section>
            <p id="temp-solutions" onclick="toggleSolution()"></p>
        </section>
    </div>
    <script>
        let currentTask = document.getElementById('current-task');
        let currentSolution = document.getElementById('solution');
        let tempSolutions = document.getElementById('temp-solutions')
        let f1input = document.getElementById('f1')
        let f2input = document.getElementById('f2')
        let navigation = document.getElementById('nav')
        let Solution = document.getElementById('Solution')
        let psolutions = document.getElementById('partial-solutions')
        let voiceMode = document.getElementById('voiceMode')
        let micImage = document.getElementById('mic-image')
        let SolutionTask = document.getElementById('Solution-task')
        let autoTaskInput = document.getElementById('autoTaskInput')
        let isVoiceModeActive = false;
        let isBeginnerModeActive = false;
        let wasSolved = false;
        let funnySmilies = ["üòã", "üòõ", "üòú", "ü§™", "üòù", "ü§ó", "ü§≠", "ü§´", "ü§®", "üòè", "ü§Ø", "ü§†", "ü•≥", "üòé", "ü§ì", "üßê", "üò≤", "üò≥", "ü•∫", "üò±", "üòà", "üò∫", "üò∏", "üòπ", "üòª", "üòº", "üòΩ", "üôÄ"]

        window.addEventListener("keydown", function (e) {

            if (e.keyCode == '13' || e.keyCode == '32') {
                // enter or space
                saveTempSolution();
            }
            else if (e.keyCode == '78') {
                // n
                newTask();
            }
            else if (e.keyCode == '83') {
                // s              
                toggleSolution();
                currentSolution.focus();
            }
            else if (e.keyCode == '79') {
                // o
                toggleNav();
            }
            else if (e.keyCode == '70') {
                // f
                toggleFullScreen();
                currentSolution.focus();
            }
            else if (e.keyCode == '86') {
                // V
                toggleVoiceMode();
                currentSolution.focus();
            }
        });

        function toggleSolution() {
            if (Solution.style.display === "none") {
                showSolution()
            } else {
                hideSolution()
                currentSolution.focus();
            }
        }

        function showSolution() {
            Solution.style.display = "block";
            hideNav();
            Solution.focus();
        }

        function hideSolution() {
            Solution.style.display = "none";
        }

        function toggleVoiceMode() {
            if (isVoiceModeActive) {
                // deactivate voice mode
                localStorage.setItem('isVoiceModeActive', false)
                currentSolution.removeAttribute("readonly")
                voiceMode.innerHTML = "(V)oice is OFF<br/><span style='font-size: x-small'>(beta)</span>"
                isVoiceModeActive = false
                micImage.classList.add("hidden")
                return
            }
            // activate voice mode
            localStorage.setItem('isVoiceModeActive', true)
            micImage.classList.remove("hidden")
            voiceMode.innerHTML = "(V)oice is ON<br/><span style='font-size: x-small'>(beta)</span>"
            currentSolution.setAttribute("readonly", "readonly")
            isVoiceModeActive = true
        }

        function toggleFullScreen() {
            var element = document.documentElement
            if (!document.fullscreen && !document.mozFullScreen && !document.webkitFullScreen && !document.msRequestFullscreen) {
                enterFullscreen(element)
            } else {
                exitFullscreen()
            }
            hideNav();
            currentSolution.focus();
        }

        function enterFullscreen(element) {
            if (element.requestFullscreen) {
                element.requestFullscreen();
            } else if (element.mozRequestFullScreen) {
                element.mozRequestFullScreen();
            } else if (element.webkitRequestFullscreen) {
                element.webkitRequestFullscreen();
            } else if (element.msRequestFullscreen) {
                element.msRequestFullscreen();
            }
        }

        function exitFullscreen() {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.mozCancelFullScreen) {
                document.mozCancelFullScreen();
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            }
        }


        let factor1 = 0;
        let factor2 = 0;
        let result = 0;
        let fractions = new Map()
        let startTime;
        let endTime;
        let autoTaskTimer;
        // let recognition;

        function validateResult() {
            //currentSolution.disabled = true;
            solution = currentSolution.value
            endTime = performance.now();
            wasSolved = true;

            updateViewSolution()

            let interval = getAutoTaskInterval();
            if (0 < interval) {
                autoTaskTimer = setInterval(function () {
                    if (!wasSolved || !endTime) {
                        clearInterval(autoTaskTimer);
                        return
                    }
                    // Get today's date and time
                    let now = performance.now();
                    if (interval < now - endTime) {
                        newTask();
                        clearInterval(autoTaskTimer);
                    }

                }, 1000);
            }
        }

        function saveAutoTaskInterval() {
            let v = autoTaskInput.value;
            console.log(v)
            if (v === "" || v == "-") {
                localStorage.setItem("autoTaskInterval", 0)
                return;
            }
            v = Math.max(1, v)
            v = Math.min(100, v)
            localStorage.setItem("autoTaskInterval", v * 1000);
            autoTaskInput.value = v;
        }

        function getAutoTaskInterval() {
            let i = localStorage.getItem("autoTaskInterval");
            if (!i || i == "") {
                saveAutoTaskInterval()
                i = localStorage.getItem("autoTaskInterval");
            }
            return i;
        }

        function calculateTask(a, b) {
            a = Math.max(1, a)
            a = Math.min(10, a)
            b = Math.max(1, b)
            b = Math.min(10, b)
            do {
                factor1 = Math.floor(Math.random() * (10 ** a));
            } while (factor1 < 2 || factor1.toString().length != a);
            do {
                factor2 = Math.floor(Math.random() * (10 ** b));
            } while (factor2 < 2 || factor2.toString().length != b);
            result = factor1 * factor2
            startTime = performance.now();
            endTime = null;
        }

        function updateView() {
            currentTask.innerText = factor1 + " * " + factor2
            //currentSolution.focus();
        }

        function updateViewSolution() {
            currentTask.innerHTML = factor1.toString() + " * " + factor2.toString() + " = <span class='valid'>" + result + " ‚úì</span>"
            currentSolution.value = ""
            currentSolution.placeholder = ""
            if (endTime) {
                currentSolution.placeholder = ((endTime - startTime).toFixed(0) / 1000).toString() + " sec."
            }
            //currentSolution.focus();
        }

        function newTask(setFocus = true) {
            let f1 = parseInt(f1input.value, 10)
            if (isNaN(f1)) {
                f1 = 1
            }
            let f2 = parseInt(f2input.value, 10)
            if (isNaN(f2)) {
                f2 = 2
            }
            let f1x = Math.max(1, f1)
            f1x = Math.min(9, f1x)
            let f2x = Math.max(1, f2)
            f2x = Math.min(9, f2x)
            if (f1 != f1x) {
                f1input.value = f1x
            }
            if (f2 != f2x) {
                f2input.value = f2x
            }
            localStorage.setItem('f1', f1x)
            localStorage.setItem('f2', f2x)

            isBeginnerModeActive = (f1x == 1 && f2x == 1);
            wasSolved = false;
            clearInterval(autoTaskTimer);

            calculateTask(f1x, f2x)
            updateView()
            resetInput()
            calculateFractions()
            if (setFocus) {
                hideNav();
                currentSolution.focus();
            }
            //startDictation();
        }

        function calculateFractions() {
            fractions = new Map();
            let f1s = factor1.toString();
            let f2s = factor2.toString();

            for (let i = 0; i < f1s.length; i++) {
                let ti = parseInt(f1s[i], 10) * Math.pow(10, f1s.length - i - 1)
                if (ti == 0) {
                    continue
                }
                for (let j = 0; j < f2s.length; j++) {
                    let tj = parseInt(f2s[j], 10) * Math.pow(10, f2s.length - j - 1);
                    if (tj == 0) {
                        continue
                    }
                    fractions.set(ti + "*" + tj, ti * tj)
                }
            }
            updateSolution()
        }

        // function creates and sets the content of the solution page for Pro mode
        function updateSolutionPro() {
            let keys = Array.from(fractions.keys());
            psolutions.innerHTML = "";
            let f1s = factor1.toString();
            let f2s = factor2.toString();
            SolutionTask.innerHTML = f1s + " * " + f2s + " = " + result.toString();
            let resultLength = result.toString().length;
            let currentSum = 0;
            keys.sort(function (a, b) {
                return b.length - a.length;
            });
            for (let i = 0; i < keys.length; i++) {
                currentSum += fractions.get(keys[i])
                let factors = keys[i].split("*");
                let f1padded = factors[0].padStart(f1s.length);
                let f2padded = factors[1].padStart(f2s.length);
                let productPadded = fractions.get(keys[i]).toString().padStart(resultLength)
                let x = currentSum * 100 / result
                psolutions.innerHTML = psolutions.innerHTML + (i + 1).toString().padStart(2) + ". " + f1padded + " * " + f2padded + " = " + productPadded + " | " + currentSum.toString().padStart(resultLength) + " ‚âô " + x.toFixed(2).padStart(6) + "%" + "<br />"
            }
        }

        // function creates and sets the content of the solution page for beginner mode
        function updateSolutionBeginner() {
            psolutions.innerHTML = "";
            let f1s = factor1.toString();
            let f2s = factor2.toString();
            SolutionTask.innerHTML = f1s + " * " + f2s + " = " + result.toString();
            let resultLength = result.toString().length;
            let currentSum = 0;
            for (let i = 1; i <= factor1; i++) {
                currentSum += factor2;
                let x = currentSum * 100 / result
                psolutions.innerHTML = psolutions.innerHTML + (i).toString() + " * " + f2s + " = " + currentSum.toString().padStart(resultLength) + " ‚âô " + x.toFixed(2).padStart(6) + "%" + "<br />"

            }
        }

        // function creates and sets the content of the solution page
        function updateSolution() {
            if (isBeginnerModeActive) {
                updateSolutionBeginner();
            } else {
                updateSolutionPro();
            }
        }

        function resetInput() {
            currentSolution.value = "";
            currentSolution.placeholder = "="
            currentTask.classList.remove("valid");
            currentTask.classList.remove("invalid");
            tempSolutions.innerHTML = ""
            //currentSolution.focus();
            currentSolution.disabled = false;
            Solution.style.display = "none";
        }

        function getRandomElement(array) {
            return array[Math.floor(Math.random() * array.length)];
        }

        function saveTempSolutionPro() {
            currentSolution.focus();
            hideNav();
            if (currentSolution.value == "") {
                if (!isVoiceModeActive) {
                    let smiley;
                    do {
                        smiley = getRandomElement(funnySmilies);
                    } while (currentSolution.placeholder == smiley);
                    currentSolution.placeholder = smiley;
                }

                return
            }
            let c = parseInt(currentSolution.value, 10)
            let analizationResult = analizeTempSolution(c)
            if (analizationResult == "") {
                tempSolutions.innerHTML = currentSolution.value + " ?<br/>" + tempSolutions.innerHTML
                if (!isVoiceModeActive) {
                    currentSolution.placeholder = "="
                }
                //startDictation();
            } else if (c == result) {
                tempSolutions.innerHTML = "<span style='color: green'>" + currentSolution.value + "</span> (" + analizationResult + ")<br/>" + tempSolutions.innerHTML
                validateResult();
            } else {
                tempSolutions.innerHTML = "<span style='color: green'>" + currentSolution.value + "</span> (" + analizationResult + ")<br/>" + tempSolutions.innerHTML
                let x = c * 100 / result
                currentSolution.placeholder = x.toFixed(1) + "%"
                //startDictation();
            }
            currentSolution.value = ""
        }

        function saveTempSolutionBeginner() {
            currentSolution.focus();
            hideNav();
            if (currentSolution.value == "") {
                if (!isVoiceModeActive) {
                    let smiley;
                    do {
                        smiley = getRandomElement(funnySmilies);
                    } while (currentSolution.placeholder == smiley);
                    currentSolution.placeholder = smiley;
                }

                return
            }
            let c = parseInt(currentSolution.value, 10)
            let analizationResult = analizeTempSolution(c)
            if (analizationResult == "") {
                tempSolutions.innerHTML = currentSolution.value + " ?<br/>" + tempSolutions.innerHTML
                if (!isVoiceModeActive) {
                    currentSolution.placeholder = "="
                }
                //startDictation();
            } else if (c == result) {
                tempSolutions.innerHTML = "<span style='color: green'>" + currentSolution.value + "</span> (" + analizationResult + ")<br/>" + tempSolutions.innerHTML
                validateResult();
            } else {
                tempSolutions.innerHTML = "<span style='color: green'>" + currentSolution.value + "</span> (" + analizationResult + ")<br/>" + tempSolutions.innerHTML
                let x = c * 100 / result
                currentSolution.placeholder = x.toFixed(1) + "%"
                //startDictation();
            }
            currentSolution.value = ""
        }

        function saveTempSolution() {
            if (wasSolved) {
                newTask();
                return;
            }
            if (isBeginnerModeActive) {
                saveTempSolutionBeginner();
            } else {
                saveTempSolutionPro();
            }
        }

        function analizeTempSolution(s) {
            if (isBeginnerModeActive) {
                let keys = sumFlat(s)
                return keys.join("+")
            }
            let keys = sumRecursive(0, 0, s)
            return keys.join("+")
        }

        function sumRecursive(i, c, s) {
            let keys = Array.from(fractions.keys());
            for (let j = i; j < keys.length; j++) {
                let newCurrent = c + fractions.get(keys[j]);
                if (newCurrent > s) {
                    continue
                }
                if (newCurrent == s) {
                    return [keys[j]]
                }
                let tempResult = sumRecursive(j + 1, newCurrent, s)
                if (0 < tempResult.length) {
                    tempResult.push(keys[j])
                    return tempResult
                }
            }
            return []
        }

        function sumFlat(s) {
            let keys = Array();
            let tempSum = 0;
            for (let i = 1; i <= factor1; i++) {
                keys.push(factor2)
                tempSum += factor2;
                if (tempSum == s) {
                    if (i == 1) {
                        return ["1*" + factor2.toString()]
                    }
                    return [i.toString() + "*" + factor2.toString() + " = " + keys.join("+")]
                }
            }
            keys = Array();
            tempSum = 0;
            for (let j = 1; j <= factor2; j++) {
                keys.push(factor1)
                tempSum += factor1;
                if (tempSum == s) {
                    if (j == 1) {
                        return ["1*" + factor1.toString()]
                    }
                    return [j.toString() + "*" + factor1.toString() + " = " + keys.join("+")]
                }
            }
            return []
        }

        function toggleNav() {
            if (navigation.classList.contains("hidden")) {
                showNav();
            } else {
                hideNav();
                currentSolution.focus();
            }
        }

        function showNav() {
            navigation.classList.remove("hidden");
            hideSolution();
            navigation.focus();
        }

        function hideNav() {
            navigation.classList.add("hidden")
        }

        function clearSolutions() {
            tempSolutions.innerHTML = ""
            currentSolution.focus();
        }

        function startDictation() {

            if (!isVoiceModeActive) {
                return;
            }

            currentSolution.placeholder = "...";

            if (window.hasOwnProperty('webkitSpeechRecognition')) {

                //if (typeof recognition === 'undefined' || recognition === null) {
                let recognition = new webkitSpeechRecognition();
                //}

                // recognition.stop();

                recognition.continuous = true;
                recognition.interimResults = true;



                recognition.lang = "de-DE";
                // recognition.lang = "en-US";
                recognition.start();

                recognition.onresult = function (e) {
                    console.log(e.results);
                    currentSolution.placeholder = e.results[e.results.length - 1][0].transcript.trim();

                    if (e.results[e.results.length - 1][0].transcript.trim() == "stop") {
                        recognition.stop();
                    }

                    if (e.results[e.results.length - 1].isFinal) {
                        if (["neue Aufgabe", "neu", "next", "weiter"].includes(e.results[e.results.length - 1][0].transcript.trim())) {
                            newTask();
                            return;
                        }
                        currentSolution.value = e.results[e.results.length - 1][0].transcript.replace("Uhr", "").trim();
                        saveTempSolution();
                        currentSolution.placeholder = "...";
                    }
                };


                recognition.onerror = function (e) {
                    recognition.stop();
                    currentSolution.placeholder = "üôâ";
                }

            }
        }

        (function () {
            if (localStorage.getItem('autoTaskInterval')) {
                if(0 < localStorage.getItem('autoTaskInterval')){
                    autoTaskInput.value = localStorage.getItem('autoTaskInterval')/1000;
                }
            }
            isVoiceModeActive = localStorage.getItem('isVoiceModeActive') != "true";
            toggleVoiceMode();

            if (localStorage.getItem('f1')) {
                f1input.value = localStorage.getItem('f1');
            }
            if (localStorage.getItem('f2')) {
                f2input.value = localStorage.getItem('f2');
            }
            newTask();
            currentSolution.focus();
        })();
    </script>
</body>

</html>
